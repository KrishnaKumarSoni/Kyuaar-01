{% extends "base.html" %}

{% block title %}Settings - Kyuaar{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold mb-2">Settings</h1>
        <p class="text-zinc-400">Manage your account preferences</p>
    </div>
    
    <!-- Settings Cards -->
    <div class="space-y-6">
        <!-- Account Information -->
        <div class="card">
            <div class="p-6 border-b border-zinc-800">
                <h2 class="text-xl font-semibold flex items-center">
                    <i class="ph ph-user mr-2 text-primary text-lg"></i>
                    Account Information
                </h2>
            </div>
            <div class="p-6">
                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-foreground mb-2">Email Address</label>
                            <div class="flex items-center space-x-3">
                                <div class="p-2 rounded-lg bg-zinc-800">
                                    <i class="ph ph-envelope text-primary text-lg"></i>
                                </div>
                                <div>
                                    <p class="font-medium text-foreground">{{ current_user.email }}</p>
                                    <p class="text-sm text-muted-foreground">Primary email address</p>
                                </div>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-foreground mb-2">Account Status</label>
                            <div class="flex items-center space-x-3">
                                <div class="p-2 rounded-lg bg-zinc-800">
                                    <i class="ph ph-check-circle text-green-400 text-lg"></i>
                                </div>
                                <div>
                                    <p class="font-medium text-green-400">Active</p>
                                    <p class="text-sm text-muted-foreground">Account is active and verified</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Default QR Style -->
        <div class="card">
            <div class="p-6 border-b border-zinc-800">
                <h2 class="text-xl font-semibold flex items-center">
                    <i class="ph ph-qr-code mr-2 text-primary text-lg"></i>
                    Default QR Style
                </h2>
            </div>
            <div class="p-6">
                <p class="text-muted-foreground mb-6">Configure the default style for QR codes generated with new packets</p>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Style Controls -->
                    <div class="space-y-6">
                        <!-- Module Drawer -->
                        <div>
                            <label class="block text-sm font-medium text-foreground mb-2">Data Pattern Style</label>
                            <select id="module-drawer" class="select-input w-full">
                                <option value="square">Square</option>
                                <option value="rounded">Rounded</option>
                                <option value="circle">Circle</option>
                                <option value="vertical_bars">Vertical Bars</option>
                                <option value="horizontal_bars">Horizontal Bars</option>
                            </select>
                        </div>
                        
                        <!-- Eye Drawer -->
                        <div>
                            <label class="block text-sm font-medium text-foreground mb-2">Corner Style</label>
                            <select id="eye-drawer" class="select-input w-full">
                                <option value="square">Square</option>
                                <option value="rounded">Rounded</option>
                                <option value="circle">Circle</option>
                            </select>
                        </div>
                        
                        <!-- Colors -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-foreground mb-2">Fill Color</label>
                                <div class="flex items-center space-x-2">
                                    <input type="color" id="fill-color" value="#000000" class="h-10 w-20 rounded border border-zinc-700 bg-zinc-800 cursor-pointer">
                                    <input type="text" id="fill-color-text" value="#000000" class="input-field flex-1" readonly>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-foreground mb-2">Background Color</label>
                                <div class="flex items-center space-x-2">
                                    <input type="color" id="back-color" value="#FFFFFF" class="h-10 w-20 rounded border border-zinc-700 bg-zinc-800 cursor-pointer">
                                    <input type="text" id="back-color-text" value="#FFFFFF" class="input-field flex-1" readonly>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Size Settings -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-foreground mb-2">Module Size</label>
                                <input type="range" id="box-size" min="5" max="20" value="10" class="w-full">
                                <div class="text-sm text-muted-foreground mt-1">Size: <span id="box-size-value">10</span>px</div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-foreground mb-2">Border Width</label>
                                <input type="range" id="border" min="1" max="10" value="4" class="w-full">
                                <div class="text-sm text-muted-foreground mt-1">Width: <span id="border-value">4</span> modules</div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="flex space-x-3 pt-4">
                            <button id="save-qr-style" class="btn btn-primary flex-1">
                                <i class="ph ph-check mr-2"></i>
                                Save as Default
                            </button>
                            <button id="reset-qr-style" class="btn btn-secondary">
                                <i class="ph ph-arrow-counter-clockwise mr-2"></i>
                                Reset
                            </button>
                        </div>
                    </div>
                    
                    <!-- Preview -->
                    <div class="flex flex-col items-center justify-center">
                        <div class="card p-6 w-full max-w-sm">
                            <h3 class="text-lg font-medium mb-4 text-center">Preview</h3>
                            <div id="qr-preview" class="flex justify-center">
                                <div class="w-48 h-48 bg-zinc-800 rounded-lg flex items-center justify-center">
                                    <i class="ph ph-qr-code text-4xl text-zinc-600"></i>
                                </div>
                            </div>
                            <p class="text-sm text-muted-foreground text-center mt-4">
                                This style will be used for all new packets
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Application Info -->
        <div class="card">
            <div class="p-6 border-b border-zinc-800">
                <h2 class="text-xl font-semibold flex items-center">
                    <i class="ph ph-info mr-2 text-primary text-lg"></i>
                    Application Information
                </h2>
            </div>
            <div class="p-6">
                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-foreground mb-2">Version</label>
                            <div class="flex items-center space-x-3">
                                <div class="p-2 rounded-lg bg-zinc-800">
                                    <i class="ph ph-package text-primary text-lg"></i>
                                </div>
                                <div>
                                    <p class="font-medium text-foreground">Kyuaar v1.0</p>
                                    <p class="text-sm text-muted-foreground">Current version</p>
                                </div>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-foreground mb-2">Theme</label>
                            <div class="flex items-center space-x-3">
                                <div class="p-2 rounded-lg bg-zinc-800">
                                    <i class="ph ph-moon text-primary text-lg"></i>
                                </div>
                                <div>
                                    <p class="font-medium text-foreground">Dark Mode</p>
                                    <p class="text-sm text-muted-foreground">Burnt orange theme</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // QR Style Settings
    const moduleDrawer = document.getElementById('module-drawer');
    const eyeDrawer = document.getElementById('eye-drawer');
    const fillColor = document.getElementById('fill-color');
    const fillColorText = document.getElementById('fill-color-text');
    const backColor = document.getElementById('back-color');
    const backColorText = document.getElementById('back-color-text');
    const boxSize = document.getElementById('box-size');
    const boxSizeValue = document.getElementById('box-size-value');
    const border = document.getElementById('border');
    const borderValue = document.getElementById('border-value');
    const saveButton = document.getElementById('save-qr-style');
    const resetButton = document.getElementById('reset-qr-style');
    const qrPreview = document.getElementById('qr-preview');
    
    let previewTimer = null;
    
    // Update text inputs when color inputs change
    fillColor.addEventListener('input', function() {
        fillColorText.value = fillColor.value.toUpperCase();
        updatePreview();
    });
    
    backColor.addEventListener('input', function() {
        backColorText.value = backColor.value.toUpperCase();
        updatePreview();
    });
    
    // Update range value displays
    boxSize.addEventListener('input', function() {
        boxSizeValue.textContent = boxSize.value;
        updatePreview();
    });
    
    border.addEventListener('input', function() {
        borderValue.textContent = border.value;
        updatePreview();
    });
    
    // Update preview on any change
    moduleDrawer.addEventListener('change', updatePreview);
    eyeDrawer.addEventListener('change', updatePreview);
    
    // Load current settings on page load
    loadCurrentSettings();
    
    // Update preview with debounce
    function updatePreview() {
        if (previewTimer) clearTimeout(previewTimer);
        
        previewTimer = setTimeout(() => {
            const settings = {
                module_drawer: moduleDrawer.value,
                eye_drawer: eyeDrawer.value,
                fill_color: fillColor.value,
                back_color: backColor.value,
                box_size: parseInt(boxSize.value),
                border: parseInt(border.value)
            };
            
            // Show loading state
            qrPreview.innerHTML = '<div class="w-48 h-48 bg-zinc-800 rounded-lg flex items-center justify-center"><i class="ph ph-spinner text-4xl text-zinc-600 animate-spin"></i></div>';
            
            // Generate preview
            fetch('/api/qr/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    url: 'https://kyuaar.com/packet/SAMPLE',
                    settings: settings
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    qrPreview.innerHTML = `<img src="${data.image_data_url}" alt="QR Preview" class="w-48 h-48 rounded-lg">`;
                } else {
                    qrPreview.innerHTML = '<div class="w-48 h-48 bg-zinc-800 rounded-lg flex items-center justify-center"><i class="ph ph-x text-4xl text-red-500"></i></div>';
                }
            })
            .catch(error => {
                console.error('Error generating preview:', error);
                qrPreview.innerHTML = '<div class="w-48 h-48 bg-zinc-800 rounded-lg flex items-center justify-center"><i class="ph ph-x text-4xl text-red-500"></i></div>';
            });
        }, 500); // Debounce 500ms
    }
    
    // Load current settings
    function loadCurrentSettings() {
        fetch('/api/settings/qr-style')
            .then(response => response.json())
            .then(data => {
                if (data.settings) {
                    moduleDrawer.value = data.settings.module_drawer || 'square';
                    eyeDrawer.value = data.settings.eye_drawer || 'square';
                    fillColor.value = data.settings.fill_color || '#000000';
                    fillColorText.value = fillColor.value.toUpperCase();
                    backColor.value = data.settings.back_color || '#FFFFFF';
                    backColorText.value = backColor.value.toUpperCase();
                    boxSize.value = data.settings.box_size || 10;
                    boxSizeValue.textContent = boxSize.value;
                    border.value = data.settings.border || 4;
                    borderValue.textContent = border.value;
                }
                updatePreview();
            })
            .catch(error => {
                console.error('Error loading settings:', error);
                updatePreview();
            });
    }
    
    // Save settings
    saveButton.addEventListener('click', function() {
        const settings = {
            module_drawer: moduleDrawer.value,
            eye_drawer: eyeDrawer.value,
            fill_color: fillColor.value,
            back_color: backColor.value,
            box_size: parseInt(boxSize.value),
            border: parseInt(border.value)
        };
        
        saveButton.disabled = true;
        saveButton.innerHTML = '<i class="ph ph-spinner animate-spin mr-2"></i>Saving...';
        
        fetch('/api/settings/qr-style', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ settings: settings })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('QR style settings saved successfully', 'success');
            } else {
                showToast('Failed to save settings', 'error');
            }
        })
        .catch(error => {
            console.error('Error saving settings:', error);
            showToast('Failed to save settings', 'error');
        })
        .finally(() => {
            saveButton.disabled = false;
            saveButton.innerHTML = '<i class="ph ph-check mr-2"></i>Save as Default';
        });
    });
    
    // Reset to defaults
    resetButton.addEventListener('click', function() {
        moduleDrawer.value = 'square';
        eyeDrawer.value = 'square';
        fillColor.value = '#000000';
        fillColorText.value = '#000000';
        backColor.value = '#FFFFFF';
        backColorText.value = '#FFFFFF';
        boxSize.value = 10;
        boxSizeValue.textContent = '10';
        border.value = 4;
        borderValue.textContent = '4';
        updatePreview();
    });
});
</script>
{% endblock %}