<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configure Your QR Packet - Kyuaar</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tailwind Config for Dark Mode and Custom Colors -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#CC5500',
                        'primary-dark': '#AA4500',
                    }
                }
            }
        }
    </script>
    
    <style>
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #CC5500;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-md">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-2xl font-bold text-primary mb-2">Kyuaar Configuration</h1>
            <p class="text-gray-400">Configure your QR packet redirect</p>
        </div>

        <!-- Configuration Form -->
        <div class="bg-gray-800 rounded-lg p-6 shadow-lg">
            <form id="configForm">
                <!-- Redirect Type Selection -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-300 mb-3">
                        Choose redirect type:
                    </label>
                    <div class="space-y-3">
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="radio" name="redirect_type" value="whatsapp" 
                                   class="text-primary bg-gray-700 border-gray-600 focus:ring-primary" checked>
                            <span class="text-white">WhatsApp</span>
                        </label>
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="radio" name="redirect_type" value="custom" 
                                   class="text-primary bg-gray-700 border-gray-600 focus:ring-primary">
                            <span class="text-white">Custom URL</span>
                        </label>
                    </div>
                </div>

                <!-- WhatsApp Configuration -->
                <div id="whatsapp-config" class="mb-6">
                    <label for="phone" class="block text-sm font-medium text-gray-300 mb-2">
                        WhatsApp Phone Number
                    </label>
                    <input type="tel" id="phone" name="phone" 
                           placeholder="Enter phone number (e.g., 9166900151)"
                           class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                    <p class="text-xs text-gray-400 mt-1">Include country code if outside India</p>
                </div>

                <!-- Custom URL Configuration -->
                <div id="custom-config" class="mb-6 hidden">
                    <label for="custom_url" class="block text-sm font-medium text-gray-300 mb-2">
                        Custom URL
                    </label>
                    <input type="url" id="custom_url" name="custom_url" 
                           placeholder="https://example.com"
                           class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>

                <!-- Current Configuration (if exists) -->
                {% if current_redirect %}
                <div class="mb-6 p-4 bg-gray-700 rounded-md">
                    <h3 class="text-sm font-medium text-gray-300 mb-2">Current Configuration:</h3>
                    <p class="text-white text-sm break-all">{{ current_redirect }}</p>
                </div>
                {% endif %}

                <!-- Submit Button -->
                <button type="submit" id="submitBtn" 
                        class="w-full bg-primary hover:bg-primary-dark text-white font-medium py-2 px-4 rounded-md transition duration-200 flex items-center justify-center">
                    <span id="submitText">Configure</span>
                    <div id="submitLoader" class="loader ml-2 hidden"></div>
                </button>
            </form>

            <!-- Success Message -->
            <div id="successMessage" class="hidden mt-4 p-4 bg-green-800 border border-green-600 rounded-md">
                <p class="text-green-200 text-sm">Configuration saved successfully!</p>
                <p class="text-green-300 text-xs mt-1">Your QR codes will now redirect to the configured destination.</p>
            </div>

            <!-- Error Message -->
            <div id="errorMessage" class="hidden mt-4 p-4 bg-red-800 border border-red-600 rounded-md">
                <p class="text-red-200 text-sm" id="errorText">An error occurred. Please try again.</p>
            </div>
        </div>

        <!-- Footer -->
        <div class="text-center mt-8">
            <p class="text-gray-500 text-sm">
                Powered by <span class="text-primary font-semibold">Kyuaar</span>
            </p>
        </div>
    </div>

    <script>
        const form = document.getElementById('configForm');
        const whatsappConfig = document.getElementById('whatsapp-config');
        const customConfig = document.getElementById('custom-config');
        const submitBtn = document.getElementById('submitBtn');
        const submitText = document.getElementById('submitText');
        const submitLoader = document.getElementById('submitLoader');
        const successMessage = document.getElementById('successMessage');
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');

        // Handle redirect type change
        document.querySelectorAll('input[name="redirect_type"]').forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value === 'whatsapp') {
                    whatsappConfig.classList.remove('hidden');
                    customConfig.classList.add('hidden');
                } else {
                    whatsappConfig.classList.add('hidden');
                    customConfig.classList.remove('hidden');
                }
            });
        });

        // Handle form submission
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Show loading state
            submitBtn.disabled = true;
            submitText.textContent = 'Configuring...';
            submitLoader.classList.remove('hidden');
            
            // Hide previous messages
            successMessage.classList.add('hidden');
            errorMessage.classList.add('hidden');

            const formData = new FormData(form);
            const redirectType = formData.get('redirect_type');
            
            let payload = {
                type: redirectType
            };

            if (redirectType === 'whatsapp') {
                const phone = formData.get('phone').trim();
                if (!phone) {
                    showError('Please enter a phone number');
                    resetSubmitButton();
                    return;
                }
                payload.phone = phone;
            } else {
                const url = formData.get('custom_url').trim();
                if (!url) {
                    showError('Please enter a valid URL');
                    resetSubmitButton();
                    return;
                }
                payload.url = url;
            }

            try {
                const response = await fetch(`/api/packets/{{ packet_id }}/configure`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (response.ok) {
                    successMessage.classList.remove('hidden');
                    form.reset();
                    
                    // Redirect after 3 seconds
                    setTimeout(() => {
                        window.location.href = result.redirect_url;
                    }, 3000);
                } else {
                    showError(result.error || 'Configuration failed');
                }
            } catch (error) {
                showError('Network error. Please check your internet connection.');
            }
            
            resetSubmitButton();
        });

        function showError(message) {
            errorText.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        function resetSubmitButton() {
            submitBtn.disabled = false;
            submitText.textContent = 'Configure';
            submitLoader.classList.add('hidden');
        }
    </script>
</body>
</html>