{% extends "base.html" %}

{% block title %}{{ packet.id }} - Kyuaar{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="mb-8">
        <div class="flex items-center mb-4">
            <a href="{{ url_for('packets.list') }}" class="btn btn-ghost p-2 mr-3">
                <i class="ph ph-arrow-left text-lg"></i>
            </a>
            <div class="flex-1">
                <h1 class="text-3xl font-bold">{{ packet.id }}</h1>
                <p class="text-zinc-400">Packet details and management</p>
            </div>
            <div class="flex items-center space-x-2">
                <span class="px-3 py-1 text-sm rounded-full 
                    {% if packet.state == 'config_done' %}bg-green-500/20 text-green-400
                    {% elif packet.state == 'setup_pending' %}bg-yellow-500/20 text-yellow-400
                    {% elif packet.state == 'setup_done' %}bg-blue-500/20 text-blue-400
                    {% elif packet.state == 'config_pending' %}bg-purple-500/20 text-purple-400
                    {% else %}bg-zinc-500/20 text-zinc-400{% endif %}">
                    {{ packet.state.replace('_', ' ').title() }}
                </span>
            </div>
        </div>
    </div>
    
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Main Details -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Packet Information -->
            <div class="card p-6">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="ph ph-info mr-2 text-primary text-lg"></i>
                    Packet Information
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <div>
                            <p class="text-sm text-muted-foreground">Packet ID</p>
                            <p class="font-mono text-lg text-foreground">{{ packet.id }}</p>
                        </div>
                        <div>
                            <p class="text-sm text-muted-foreground">QR Count</p>
                            <p class="text-lg font-semibold text-foreground">{{ packet.qr_count }} codes</p>
                        </div>
                        <div>
                            <p class="text-sm text-muted-foreground">Sale Price</p>
                            <p class="text-lg font-semibold text-foreground">
                                {% if packet.sale_price %}
                                    ₹{{ packet.sale_price|int }}
                                {% else %}
                                    <span class="text-zinc-400">Not set</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <p class="text-sm text-zinc-400">Created</p>
                            <p class="text-lg">{{ packet.created_at.strftime('%b %d, %Y at %I:%M %p') if packet.created_at else 'Unknown' }}</p>
                        </div>
                        <div>
                            <p class="text-sm text-zinc-400">Last Updated</p>
                            <p class="text-lg">{{ packet.updated_at.strftime('%b %d, %Y at %I:%M %p') if packet.updated_at else 'Unknown' }}</p>
                        </div>
                        <div>
                            <p class="text-sm text-zinc-400">Base URL</p>
                            <p class="font-mono text-sm break-all">{{ packet.base_url }}</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- QR Image -->
            {% if packet.qr_image_url %}
            <div class="card p-6">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="ph ph-qr-code mr-2 text-primary text-lg"></i>
                    QR Code Image
                </h2>
                
                <div class="flex items-center justify-center">
                    <img 
                        src="{{ packet.qr_image_url }}" 
                        alt="QR Code for {{ packet.id }}"
                        class="max-w-xs border border-zinc-700 rounded-lg"
                    >
                </div>
                
                <div class="mt-4 flex items-center justify-center space-x-3">
                    <a href="{{ packet.qr_image_url }}" target="_blank" class="btn btn-ghost">
                        <i class="ph ph-download mr-2"></i>
                        Download
                    </a>
                    <button onclick="copyToClipboard('{{ packet.base_url }}')" class="btn btn-ghost">
                        <i class="ph ph-copy mr-2"></i>
                        Copy URL
                    </button>
                </div>
            </div>
            {% endif %}
            
            <!-- Sale Information -->
            {% if packet.is_sold() %}
            <div class="card p-6">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="ph ph-currency-circle-dollar mr-2 text-primary text-lg"></i>
                    Sale Information
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <div>
                            <p class="text-sm text-zinc-400">Buyer Name</p>
                            <p class="text-lg font-semibold">{{ packet.buyer_name or 'Not provided' }}</p>
                        </div>
                        <div>
                            <p class="text-sm text-zinc-400">Buyer Email</p>
                            <p class="text-lg">{{ packet.buyer_email or 'Not provided' }}</p>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <p class="text-sm text-zinc-400">Sale Price</p>
                            <p class="text-lg font-semibold">₹{{ packet.sale_price|int if packet.sale_price else 'Not set' }}</p>
                        </div>
                        <div>
                            <p class="text-sm text-zinc-400">Sale Date</p>
                            <p class="text-lg">{{ packet.sale_date.strftime('%b %d, %Y at %I:%M %p') if packet.sale_date else 'Unknown' }}</p>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Configuration -->
            {% if packet.is_configured() %}
            <div class="card p-6">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="ph ph-link mr-2 text-primary text-lg"></i>
                    Redirect Configuration
                </h2>
                
                <div class="space-y-4">
                    <div>
                        <p class="text-sm text-zinc-400">Redirect URL</p>
                        <div class="flex items-center space-x-2">
                            <p class="font-mono text-sm break-all flex-1 p-2 bg-zinc-800 rounded">{{ packet.redirect_url }}</p>
                            <button onclick="copyToClipboard('{{ packet.redirect_url }}')" class="btn btn-ghost p-2">
                                <i class="ph ph-copy"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-3">
                        <a href="{{ packet.redirect_url }}" target="_blank" class="btn btn-primary">
                            <i class="ph ph-arrow-square-out mr-2"></i>
                            Test Redirect
                        </a>
                        <a href="{{ packet.base_url }}" target="_blank" class="btn btn-secondary">
                            <i class="ph ph-qr-code mr-2"></i>
                            View QR Page
                        </a>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- Actions Sidebar -->
        <div class="space-y-6">
            <!-- Status Actions -->
            <div class="card p-6">
                <h3 class="text-lg font-semibold mb-4">Actions</h3>
                
                <div class="space-y-3">
                    {% if packet.state == 'setup_pending' %}
                    <button onclick="uploadQRImage()" class="btn btn-primary w-full">
                        <i class="ph ph-upload mr-2"></i>
                        Upload QR Image
                    </button>
                    {% elif packet.state == 'setup_done' %}
                    <button onclick="showSellModal()" class="btn btn-primary w-full">
                        <i class="ph ph-currency-circle-dollar mr-2"></i>
                        Mark as Sold
                    </button>
                    {% elif packet.state == 'config_pending' %}
                    <div class="p-3 rounded-lg bg-blue-500/10 border border-blue-500/20">
                        <p class="text-blue-300 text-sm">
                            <i class="ph ph-clock mr-1"></i>
                            Waiting for customer to configure redirect
                        </p>
                    </div>
                    {% elif packet.state == 'config_done' %}
                    <div class="p-3 rounded-lg bg-green-500/10 border border-green-500/20">
                        <p class="text-green-300 text-sm">
                            <i class="ph ph-check-circle mr-1"></i>
                            Packet is active and configured
                        </p>
                    </div>
                    {% endif %}
                    
                    <a href="{{ url_for('packets.list') }}" class="btn btn-ghost w-full">
                        <i class="ph ph-list mr-2"></i>
                        Back to List
                    </a>
                </div>
            </div>
            
            <!-- Quick Stats -->
            <div class="card p-6">
                <h3 class="text-lg font-semibold mb-4">Quick Stats</h3>
                
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <span class="text-zinc-400">State</span>
                        <span class="font-semibold">{{ packet.state.replace('_', ' ').title() }}</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-zinc-400">QR Codes</span>
                        <span class="font-semibold">{{ packet.qr_count }}</span>
                    </div>
                    {% if packet.sale_price %}
                    <div class="flex items-center justify-between">
                        <span class="text-zinc-400">Sale Price</span>
                        <span class="font-semibold text-green-400">₹{{ packet.sale_price|int }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sell Modal -->
<div id="sellModal" class="fixed inset-0 bg-black/50 backdrop-blur hidden items-center justify-center z-50" x-data="{ show: false }" x-show="show">
    <div class="card max-w-md w-full mx-4 p-6" @click.away="show = false">
        <h3 class="text-xl font-semibold mb-4">Mark Packet as Sold</h3>
        
        <form onsubmit="markAsSold(event)" class="space-y-4">
            <div class="space-y-2">
                <label for="buyer_name" class="block text-sm font-medium text-foreground mb-2">Buyer Name *</label>
                <input 
                    id="buyer_name" 
                    name="buyer_name" 
                    type="text" 
                    required
                    class="w-full px-3 py-2 rounded-lg border border-zinc-800 bg-zinc-900 text-white placeholder-zinc-500 focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary transition-colors" 
                    placeholder="Customer name"
                >
            </div>
            
            <div class="space-y-2">
                <label for="buyer_email" class="block text-sm font-medium text-foreground mb-2">Buyer Email</label>
                <input 
                    id="buyer_email" 
                    name="buyer_email" 
                    type="email" 
                    class="w-full px-3 py-2 rounded-lg border border-zinc-800 bg-zinc-900 text-white placeholder-zinc-500 focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary transition-colors" 
                    placeholder="customer@example.com"
                >
            </div>
            
            <div class="space-y-2">
                <label for="sale_price" class="block text-sm font-medium text-foreground mb-2">Sale Price (₹)</label>
                <div class="relative">
                    <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-zinc-400">₹</span>
                    <input 
                        id="sale_price" 
                        name="sale_price" 
                        type="number" 
                        step="1"
                        min="0"
                        class="w-full pl-8 pr-3 py-2 rounded-lg border border-zinc-800 bg-zinc-900 text-white placeholder-zinc-500 focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary transition-colors" 
                        placeholder="500"
                        value="{{ packet.sale_price|int if packet.sale_price else 500 }}"
                    >
                </div>
            </div>
            
            <div class="flex items-center justify-end space-x-3 pt-4">
                <button type="button" onclick="hideSellModal()" class="btn btn-ghost">
                    Cancel
                </button>
                <button type="submit" class="btn btn-primary">
                    <i class="ph ph-check mr-2"></i>
                    Mark as Sold
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function showSellModal() {
    document.getElementById('sellModal').classList.remove('hidden');
    document.getElementById('sellModal').classList.add('flex');
}

function hideSellModal() {
    document.getElementById('sellModal').classList.add('hidden');
    document.getElementById('sellModal').classList.remove('flex');
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text);
    // Could add a toast notification here
}

function uploadQRImage() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/png,image/jpeg,image/jpg';
    input.onchange = async function(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const formData = new FormData();
        formData.append('qr_image', file);
        
        try {
            const response = await fetch(`/api/packets/{{ packet.id }}/upload`, {
                method: 'POST',
                body: formData
            });
            
            if (response.ok) {
                location.reload();
            } else {
                const error = await response.json();
                alert('Upload failed: ' + (error.error || 'Unknown error'));
            }
        } catch (error) {
            alert('Upload error: ' + error.message);
        }
    };
    input.click();
}

async function markAsSold(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const data = {
        buyer_name: formData.get('buyer_name'),
        buyer_email: formData.get('buyer_email'),
        sale_price: parseFloat(formData.get('sale_price')) || null
    };
    
    try {
        const response = await fetch(`/api/packets/{{ packet.id }}/sell`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            location.reload();
        } else {
            const error = await response.json();
            alert('Failed to mark as sold: ' + (error.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}
</script>
{% endblock %}