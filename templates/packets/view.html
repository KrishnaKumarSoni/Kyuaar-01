{% extends "base.html" %}

{% block title %}{{ packet.id }} - Kyuaar{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="mb-8">
        <div class="flex items-center mb-4">
            <a href="{{ url_for('packets.list') }}" class="btn btn-ghost p-2 mr-3">
                <i class="ph ph-arrow-left text-lg"></i>
            </a>
            <div class="flex-1">
                <h1 class="text-3xl font-bold">{{ packet.id }}</h1>
                <p class="text-zinc-400">Packet details and management</p>
            </div>
            <div class="flex items-center space-x-2">
                <span class="px-3 py-1 text-sm rounded-full 
                    {% if packet.state == 'config_done' %}bg-green-500/20 text-green-400
                    {% elif packet.state == 'setup_done' %}bg-blue-500/20 text-blue-400
                    {% elif packet.state == 'config_pending' %}bg-purple-500/20 text-purple-400
                    {% else %}bg-zinc-500/20 text-zinc-400{% endif %}">
                    {{ packet.state.replace('_', ' ').title() }}
                </span>
            </div>
        </div>
    </div>
    
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Main Details -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Packet Information -->
            <div class="card p-6">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="ph ph-info mr-2 text-primary text-lg"></i>
                    Packet Information
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <div>
                            <p class="text-sm text-muted-foreground">Packet ID</p>
                            <p class="font-mono text-lg text-foreground">{{ packet.id }}</p>
                        </div>
                        <div>
                            <p class="text-sm text-muted-foreground">QR Count</p>
                            <p class="text-lg font-semibold text-foreground">{{ packet.qr_count }} codes</p>
                        </div>
                        <div>
                            <p class="text-sm text-muted-foreground">Price</p>
                            <p class="text-lg font-semibold text-foreground">
                                {% if packet.is_sold() and packet.sale_price %}
                                    ₹{{ packet.sale_price|int }}
                                {% elif packet.price %}
                                    ₹{{ packet.price|int }}
                                {% else %}
                                    <span class="text-zinc-400">Not set</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <p class="text-sm text-zinc-400">Created</p>
                            <p class="text-lg">{{ packet.created_at.strftime('%b %d, %Y at %I:%M %p') if packet.created_at else 'Unknown' }}</p>
                        </div>
                        <div>
                            <p class="text-sm text-zinc-400">Last Updated</p>
                            <p class="text-lg">{{ packet.updated_at.strftime('%b %d, %Y at %I:%M %p') if packet.updated_at else 'Unknown' }}</p>
                        </div>
                        <div>
                            <p class="text-sm text-zinc-400">Base URL</p>
                            <p class="font-mono text-sm break-all">{{ packet.base_url }}</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- QR Codes -->
            {% if packet.qr_image_url %}
            <div class="card p-6">
                <h2 class="text-xl font-semibold mb-6 flex items-center">
                    <i class="ph ph-qr-code mr-2 text-primary text-lg"></i>
                    QR Code Images
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Main QR Code (Customer-facing) -->
                    <div class="space-y-4">
                        <div class="text-center">
                            <h3 class="text-lg font-semibold text-foreground mb-2">Main QR Code</h3>
                            <p class="text-sm text-zinc-400 mb-4">For customers to scan and configure</p>
                            
                            <div class="flex items-center justify-center mb-4">
                                <img 
                                    src="{{ packet.qr_image_url }}" 
                                    alt="Main QR Code for {{ packet.id }}"
                                    class="max-w-[200px] border border-zinc-700 rounded-lg"
                                >
                            </div>
                            
                            <div class="space-y-2">
                                <a href="{{ packet.qr_image_url }}" target="_blank" class="btn btn-ghost w-full text-sm">
                                    <i class="ph ph-download mr-2"></i>
                                    Download Main QR
                                </a>
                                <button onclick="copyToClipboard('{{ packet.base_url }}')" class="btn btn-ghost w-full text-sm">
                                    <i class="ph ph-copy mr-2"></i>
                                    Copy Main URL
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Master QR Code (Update/Management) -->
                    {% if packet.master_qr_url %}
                    <div class="space-y-4">
                        <div class="text-center">
                            <h3 class="text-lg font-semibold text-foreground mb-2">Master QR Code</h3>
                            <p class="text-sm text-zinc-400 mb-4">For updating redirect without reprints</p>
                            
                            <div class="flex items-center justify-center mb-4">
                                <img 
                                    src="{{ packet.master_qr_url }}" 
                                    alt="Master QR Code for {{ packet.id }}"
                                    class="max-w-[200px] border border-orange-500/30 rounded-lg"
                                >
                            </div>
                            
                            <div class="space-y-2">
                                <a href="{{ packet.master_qr_url }}" target="_blank" class="btn btn-ghost w-full text-sm">
                                    <i class="ph ph-download mr-2"></i>
                                    Download Master QR
                                </a>
                                <button onclick="copyToClipboard('{{ url_for('handle_master_qr', master_id=packet.master_id, _external=True) }}')" class="btn btn-ghost w-full text-sm">
                                    <i class="ph ph-copy mr-2"></i>
                                    Copy Master URL
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Usage Instructions -->
                <div class="mt-6 p-4 bg-zinc-800/50 rounded-lg border border-zinc-700">
                    <h4 class="text-sm font-semibold text-foreground mb-2">
                        <i class="ph ph-info mr-1"></i>
                        Usage Instructions
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-zinc-300">
                        <div>
                            <p class="font-medium text-blue-400 mb-1">Main QR Code:</p>
                            <p>Print and distribute to customers. They scan to set up initial redirect URL (WhatsApp/website).</p>
                        </div>
                        {% if packet.master_qr_url %}
                        <div>
                            <p class="font-medium text-orange-400 mb-1">Master QR Code:</p>
                            <p>Keep private. Customers can scan to update redirect URL without reprinting stickers (3 updates/day limit).</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Sale Information -->
            {% if packet.is_sold() %}
            <div class="card p-6">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="ph ph-currency-circle-dollar mr-2 text-primary text-lg"></i>
                    Sale Information
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <div>
                            <p class="text-sm text-zinc-400">Buyer Name</p>
                            <p class="text-lg font-semibold">{{ packet.buyer_name or 'Not provided' }}</p>
                        </div>
                        <div>
                            <p class="text-sm text-zinc-400">Buyer Email</p>
                            <p class="text-lg">{{ packet.buyer_email or 'Not provided' }}</p>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <p class="text-sm text-zinc-400">Sale Price</p>
                            <p class="text-lg font-semibold">₹{{ packet.sale_price|int if packet.sale_price else packet.price|int if packet.price else 'Not set' }}</p>
                        </div>
                        <div>
                            <p class="text-sm text-zinc-400">Sale Date</p>
                            <p class="text-lg">{{ packet.sale_date.strftime('%b %d, %Y at %I:%M %p') if packet.sale_date else 'Unknown' }}</p>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Configuration -->
            {% if packet.is_configured() %}
            <div class="card p-6">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="ph ph-link mr-2 text-primary text-lg"></i>
                    Redirect Configuration
                </h2>
                
                <div class="space-y-4">
                    <div>
                        <p class="text-sm text-zinc-400">Redirect URL</p>
                        <div class="flex items-center space-x-2">
                            <p class="font-mono text-sm break-all flex-1 p-2 bg-zinc-800 rounded">{{ packet.redirect_url }}</p>
                            <button onclick="copyToClipboard('{{ packet.redirect_url }}')" class="btn btn-ghost p-2">
                                <i class="ph ph-copy"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-3">
                        <a href="{{ packet.redirect_url }}" target="_blank" class="btn btn-primary">
                            <i class="ph ph-arrow-square-out mr-2"></i>
                            Test Redirect
                        </a>
                        <a href="{{ packet.base_url }}" target="_blank" class="btn btn-secondary">
                            <i class="ph ph-qr-code mr-2"></i>
                            View QR Page
                        </a>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- Actions Sidebar -->
        <div class="space-y-6">
            <!-- Status Actions -->
            <div class="card p-6">
                <h3 class="text-lg font-semibold mb-4">Actions</h3>
                
                <div class="space-y-3">
                    {% if packet.state == 'setup_done' %}
                    <button onclick="showSellModal()" class="btn btn-primary w-full">
                        <i class="ph ph-currency-circle-dollar mr-2"></i>
                        Mark as Sold
                    </button>
                    {% elif packet.state == 'config_pending' %}
                    <div class="p-3 rounded-lg bg-blue-500/10 border border-blue-500/20">
                        <p class="text-blue-300 text-sm">
                            <i class="ph ph-clock mr-1"></i>
                            Waiting for customer to configure redirect
                        </p>
                    </div>
                    {% elif packet.state == 'config_done' %}
                    <div class="p-3 rounded-lg bg-green-500/10 border border-green-500/20">
                        <p class="text-green-300 text-sm">
                            <i class="ph ph-check-circle mr-1"></i>
                            Packet is active and configured
                        </p>
                    </div>
                    {% endif %}
                    
                    <a href="{{ url_for('packets.list') }}" class="btn btn-ghost w-full">
                        <i class="ph ph-list mr-2"></i>
                        Back to List
                    </a>
                </div>
            </div>
            
            <!-- Quick Stats -->
            <div class="card p-6">
                <h3 class="text-lg font-semibold mb-4">Quick Stats</h3>
                
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <span class="text-zinc-400">State</span>
                        <span class="font-semibold">{{ packet.state.replace('_', ' ').title() }}</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-zinc-400">QR Codes</span>
                        <span class="font-semibold">{{ packet.qr_count }}</span>
                    </div>
                    {% if packet.is_sold() and packet.sale_price %}
                    <div class="flex items-center justify-between">
                        <span class="text-zinc-400">Sale Price</span>
                        <span class="font-semibold text-green-400">₹{{ packet.sale_price|int }}</span>
                    </div>
                    {% elif packet.price %}
                    <div class="flex items-center justify-between">
                        <span class="text-zinc-400">Price</span>
                        <span class="font-semibold">₹{{ packet.price|int }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sell Modal -->
<div id="sellModal" class="fixed inset-0 bg-black/50 backdrop-blur hidden items-center justify-center z-50" x-data="{ show: false }" x-show="show">
    <div class="card max-w-md w-full mx-4 p-6" @click.away="show = false">
        <h3 class="text-xl font-semibold mb-4">Mark Packet as Sold</h3>
        
        <form onsubmit="markAsSold(event)" class="space-y-4">
            <div class="space-y-2">
                <label for="buyer_name" class="block text-sm font-medium text-foreground mb-2">Buyer Name *</label>
                <input 
                    id="buyer_name" 
                    name="buyer_name" 
                    type="text" 
                    required
                    class="w-full px-3 py-2 rounded-lg border border-zinc-800 bg-zinc-900 text-white placeholder-zinc-500 focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary transition-colors" 
                    placeholder="Customer name"
                >
            </div>
            
            <div class="space-y-2">
                <label for="buyer_email" class="block text-sm font-medium text-foreground mb-2">Buyer Email</label>
                <input 
                    id="buyer_email" 
                    name="buyer_email" 
                    type="email" 
                    class="w-full px-3 py-2 rounded-lg border border-zinc-800 bg-zinc-900 text-white placeholder-zinc-500 focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary transition-colors" 
                    placeholder="customer@example.com"
                >
            </div>
            
            <div class="space-y-2">
                <label for="sale_price" class="block text-sm font-medium text-foreground mb-2">Sale Price (₹)</label>
                <div class="relative">
                    <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-zinc-400">₹</span>
                    <input 
                        id="sale_price" 
                        name="sale_price" 
                        type="number" 
                        step="1"
                        min="0"
                        class="w-full pl-8 pr-3 py-2 rounded-lg border border-zinc-800 bg-zinc-900 text-white placeholder-zinc-500 focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary transition-colors" 
                        placeholder="500"
                        value="{{ packet.sale_price|int if packet.sale_price else 500 }}"
                    >
                </div>
            </div>
            
            <div class="flex items-center justify-end space-x-3 pt-4">
                <button type="button" onclick="hideSellModal()" class="btn btn-ghost">
                    Cancel
                </button>
                <button type="submit" class="btn btn-primary">
                    <i class="ph ph-check mr-2"></i>
                    Mark as Sold
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function showSellModal() {
    document.getElementById('sellModal').classList.remove('hidden');
    document.getElementById('sellModal').classList.add('flex');
}

function hideSellModal() {
    document.getElementById('sellModal').classList.add('hidden');
    document.getElementById('sellModal').classList.remove('flex');
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text);
    // Could add a toast notification here
}

// QR upload functionality removed - QR codes are now auto-generated

async function markAsSold(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const data = {
        buyer_name: formData.get('buyer_name'),
        buyer_email: formData.get('buyer_email'),
        sale_price: parseFloat(formData.get('sale_price')) || null
    };
    
    try {
        const response = await fetch(`/api/packets/{{ packet.id }}/sell`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            location.reload();
        } else {
            const error = await response.json();
            alert('Failed to mark as sold: ' + (error.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}
</script>
{% endblock %}